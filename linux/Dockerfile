FROM node
MAINTAINER name <email@domain.com>

#env variables
ENV vso_username=""
ENV vso_password=""
ENV vso_url=""
ENV vso_agentname=$HOSTNAME
ENV vso_agentpool=default
ENV vso_service_username=vsoservice
ENV vso_service_password=vsoservice

RUN apt-get update

# INSTALL Expect
RUN apt-get install expect -y

# INSTALL GIT
RUN apt-get install nodejs-legacy -y

# INSTALL VSO Agent
RUN npm install vsoagent-installer bower gulp -g

#CREATE SOME dirs
RUN mkdir opt/buildagent
RUN mkdir opt/buildagent/_work

#COPY expect file
WORKDIR /opt/buildagent
COPY ConfigureAgent.expect ConfigureAgent.expect

#  Create a service user 
RUN echo "${vso_service_username}\n${vso_service_password}\n\n\n\n\n\n\n" | adduser ${vso_service_username}
RUN su ${vso_service_username}

#  Install the agent
WORKDIR /opt/buildagent
RUN vsoagent-installer
WORKDIR /opt/buildagent/agent
RUN chown -R ${vso_service_username} /opt/buildagent

WORKDIR /opt/buildagent

USER ${vso_service_username}
CMD expect ConfigureAgent.expect
